#!/usr/bin/env fish
g rise

# Remove existing image files
for dir in lib/images/*
    rm $dir/*
end

# Copy images
cp -r (p utransfer)/Rise\ Art/introduction lib/images/
cp -r (p utransfer)/Rise\ Art/characters lib/images/
cp -r (p utransfer)/Rise\ Art/classes lib/images/
cp -r (p utransfer)/Rise\ Art/combat lib/images/
cp -r (p utransfer)/Rise\ Art/core\ mechanics lib/images/
cp -r (p utransfer)/Rise\ Art/equipment lib/images/
cp -r (p utransfer)/Rise\ Art/feats lib/images/
cp -r (p utransfer)/Rise\ Art/mystic\ spheres lib/images/
cp -r (p utransfer)/Rise\ Art/monsters lib/images/
cp -r (p utransfer)/Rise\ Art/the\ universe lib/images/
cp -r (p utransfer)/Rise\ Art/optional\ rules lib/images/

# Convert images to limit pdf size
for dir in lib/images/*
    echo "Converting images in $dir"
    # Shrink large images and convert to jpg
    magick.exe mogrify -resize 512x512 -format jpg $dir/*
    # Remove the old png images
    rm $dir/*.png
end

# Move emoji after jpg conversion to retain original transparency
cp -r (p utransfer)/Rise\ Art/emoji lib/images/

# clean up any jpg conversions
rm lib/images/emoji/*.jpg

echo "generating autogenerated files"
# Generate autogenerated files
mkdir -p core_book/generated
mkdir -p tome_of_creation/generated
g rust
./src/bin/generate_rust_files.fish

g rts
npx tsc --incremental
# npm run script -- src/scripts/generate_latex.js -t monsters -o ../core_book/generated/monster_descriptions.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_lists -o ../tome_of_creation/generated/mystic_sphere_lists.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_summaries -o ../tome_of_creation/generated/mystic_sphere_summaries.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_descriptions -o ../tome_of_creation/generated/mystic_sphere_descriptions.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_lists -o ../tome_of_creation/generated/combat_style_lists.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_summaries -o ../tome_of_creation/generated/combat_style_summaries.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_descriptions -o ../tome_of_creation/generated/combat_style_descriptions.tex
g rise
rm -r html_book/generated
cp -r core_book/generated html_book/generated
cp -r tome_of_creation/generated html_book/generated
