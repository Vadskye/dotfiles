#!/usr/bin/env fish
g rise

# Remove existing image files
for dir in core_book/images/*
    rm $dir/*
end

# Copy images
cp -r (p utransfer)/Rise\ Art/introduction core_book/images/
cp -r (p utransfer)/Rise\ Art/characters core_book/images/
cp -r (p utransfer)/Rise\ Art/classes core_book/images/
cp -r (p utransfer)/Rise\ Art/combat core_book/images/
cp -r (p utransfer)/Rise\ Art/core\ mechanics core_book/images/
cp -r (p utransfer)/Rise\ Art/equipment core_book/images/
cp -r (p utransfer)/Rise\ Art/feats core_book/images/
cp -r (p utransfer)/Rise\ Art/mystic\ spheres core_book/images/
cp -r (p utransfer)/Rise\ Art/monsters core_book/images/
cp -r (p utransfer)/Rise\ Art/the\ universe core_book/images/
cp -r (p utransfer)/Rise\ Art/optional\ rules core_book/images/

# Convert images to limit pdf size
for dir in core_book/images/*
    echo "Converting images in $dir"
    # Shrink large images and convert to jpg
    magick.exe mogrify -resize 512x512 -format jpg $dir/*
    # Remove the old png images
    rm $dir/*.png
end

# Move emoji after jpg conversion to retain original transparency
cp -r (p utransfer)/Rise\ Art/emoji core_book/images/

# clean up any jpg conversions
rm core_book/images/emoji/*.jpg

echo "generating autogenerated files"
# Generate autogenerated files
mkdir -p core_book/generated
g rust
cargo run --bin classes_chapter > (p rise)/core_book/generated/classes.tex
cargo run --bin monsters_chapter > (p rise)/core_book/generated/monster_descriptions.tex
cargo run --bin monster_reference_table > (p rise)/core_book/generated/monster_reference_table.tex
cargo run --bin modules_chapter > (p rise)/core_book/generated/modules.tex
g rpy
vf activate rise_book
set -x PYTHONPATH (p rise)/python
latex_generation/gen_all.py
vf deactivate
g rts
npx tsc --incremental
# npm run script -- src/scripts/generate_latex.js -t monsters -o ../core_book/generated/monster_descriptions.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_lists -o ../core_book/generated/mystic_sphere_lists.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_summaries -o ../core_book/generated/mystic_sphere_summaries.tex
npm run script -- src/scripts/generate_latex.js -t mystic_sphere_descriptions -o ../core_book/generated/mystic_sphere_descriptions.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_lists -o ../core_book/generated/combat_style_lists.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_summaries -o ../core_book/generated/combat_style_summaries.tex
npm run script -- src/scripts/generate_latex.js -t combat_style_descriptions -o ../core_book/generated/combat_style_descriptions.tex
g rise
rm -r html_book/generated
cp -r core_book/generated html_book/generated
